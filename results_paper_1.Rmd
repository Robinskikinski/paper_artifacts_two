---
title: "Results Paper 1"
author: "Robin"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
---

```{r}
rm(list = ls())
```

```{r setup, include=FALSE}
.libPaths(file.path("C:", "RLibNew")) # Set path to packages

knitr::opts_chunk$set(echo = TRUE,
                      fig.path = "Plots/Ratings/", # Ordner in dem die Grafiken gespeichert werden
                      dpi = 300, # Auflösung der Grafiken,
                      fig.height = 4.78, # Hohe der Grafiken (Zoll). 4.78 für
                      fig.width = 6, # Breite der Grafiken (Zoll). 9.1 fü
                      dev = "jpeg",
                      warning = FALSE
                      )
```

## Goal

The prevalence of artifacts and which image characteristics promote them.

  * Frequency Plot
  * Correlations
  


## Loading libraries, functions and exclusion criteris

```{r}
#install.packages("apaTables")

library(car)
library(knitr)
library(lavaan)
library(tidyverse)
library(readxl)
library(kableExtra)
library(here)
library(apa)
library(psych)
library(irr)
library(cowplot)
library(apaTables)
library(Hmisc)
library(kableExtra)
#library(knitr)
library(GGally)

select <- dplyr::select
```

```{r}
if(!exists("theme_casra", mode="function"))
source(here("src",  "CorporateDesignForR_Beta.R"))

source(here("src",  "functions.R"))
```

## Loading and clean variables

```{r}
knit(
  here("src","PrepareVariables.Rmd"),
  quiet = T
  )
```

```{r}

items_of_interest <- c( # in order in Figures
  
  "Placement Artifact",
  "Alignment Artifact",
  "Unrealistic Scenario",
  "Artificial in General",
  "FTI Targ. View Diff.",
  "Superposition",
  "Clutter",
  "Opacity"
  
)


PerformanceAndRatingsImages <- PerformanceAndRatingsImages %>%
  filter(Item %in% items_of_interest)

```

```{r}
order_optional_artifs <- c( # in order in Figures
  
  "Color Artifact",
  "Size Artifact",
  "Resolution Artifact",
  "Distortion Artifact",
  "Edges Artifact"
  
)

FreqOptCorLong <- FreqOptCorLong %>%
  mutate(Item = factor(Item, levels = order_optional_artifs))

FreqOptInBagLong <- FreqOptInBagLong %>%
  mutate(Item = factor(Item, levels = order_optional_artifs))
```


## Overview dfs

```{r}
glimpse(PerformanceAndRatingsImagesWide)

glimpse(FreqRepMainAIBFs)
glimpse(FreqOptCorLong)
```

## ICCs

```{r}
PerformanceAndRatingsImages
```


## Representative prevalence

Info: Already corrected for oversampling in PrepareVariables.Rmd

### Main artifacts, unrealistic scenario and IBFs

```{r}
FreqRepMainAIBFs <- FreqRepMainAIBFs %>%
  filter(Item %in% items_of_interest) %>%
  mutate(Item = factor(Item, levels = items_of_interest))
```


```{r}
gAlPlRep <- FreqRepMainAIBFs %>%
  filter(Item %in% c("Placement Artifact", "Alignment Artifact")) %>%
ggplot_freq(
  item. = "Item",
  rating. = "RatingRd",
  prctg. = "PercentageCorr") +
  theme(plot.margin = margin(t = 20, r =15, b = 10, l = 0))

gGenSceRep <- FreqRepMainAIBFs %>%
  filter(Item %in% c("Unrealistic Scenario", "Artificial in General")) %>%
ggplot_freq(
  item. = "Item",
  rating. = "RatingRd",
  prctg. = "PercentageCorr") +
  theme(legend.position = "None")

gIBFsRep <- FreqRepMainAIBFs %>%
  filter(Item %in% c(
    "FTI Targ. View Diff.",
    "Superposition",
    "Clutter",
    "Opacity")) %>%
ggplot_freq(
  item. = "Item",
  rating. = "RatingRd",
  prctg. = "PercentageCorr") +
  theme(legend.position = "None")
```


### Optional artifacts

```{r}
gRepOtherArtifacts <- FreqOptCorLong %>%
ggplot_freq(
  item. = "Item",
  rating. = "Rating",
  prctg. = "PercentageCorr") +
  theme(legend.position = "None")
```


### Plot together

```{r PrevBagFull, fig.height=6, fig.width=5}
  plot_grid(gAlPlRep, gRepOtherArtifacts, gGenSceRep, gIBFsRep, 
            ncol = 1,
            align = "v",
            axis = "t",
            rel_heights = c(.25, .27, .16,  .23),
            labels =  c("(a)", "(b)", "(c)", "(d)"),
            label_colour = goodContrastGrey,
            label_fontface = "plain",
            label_y = c(1, 1.1, 1.1, 1.1))

```

```{r fig.height=2}
plotFctsIss <- SumPrevArtsUnrSc %>%
  arrange(desc(PrevalenceCorr)) %>%
  select(Issue) %>%
  unlist()

SumPrevArtsUnrSc %>%
  mutate(Issue = factor(Issue, levels = rev(plotFctsIss))) %>%
  ggplot(aes(x = Issue, y = PrevalenceCorr)) +
  geom_bar(stat = "identity", width = .7) +
  geom_text(
    aes(
      label = paste0(round(PrevalenceCorr, 2) , " (good: ", 1-round(PrevalenceCorr, 2), ")"),
      y = PrevalenceCorr + .02),
    hjust = 0,
    size = 3.5) +
  scale_y_continuous(limits = c(0,1)) +
  coord_flip() +
  theme_minimal() +
  theme(axis.title.y = element_blank())
```

## FTI in bag vs. FTI on loose items

### Prevalence in bag

```{r}
FreqInBag <- PerformanceAndRatingsImagesWide %>%
  group_by(Performance, FTI_In_Bag) %>%
  summarise(nTIPImages = n()) %>%
  mutate(nTIPImagesCor = n_cor_for_oversampling(nTIPImages, Performance))

FreqInBag

FreqInBag %>%
  group_by(FTI_In_Bag) %>%
  summarise(
    nTIPImages = sum(nTIPImages),
    nTIPImagesCor = sum(nTIPImagesCor)
  ) %>%
  ungroup() %>%
  mutate(
    Prevalence = nTIPImages/600,
    PrevalenceCor = nTIPImagesCor/600
  )
  
```


### Main arifacs & others

```{r}
FreqWInBAG <- FreqWInBAG %>%
  mutate(Item = factor(Item, levels = items_of_interest))

FreqWInBAG <- FreqWInBAG %>%
  mutate(FTI_In_BagLabel = ifelse(FTI_In_Bag,
                                  "FTI in piece of baggage",
                                  "FTI on loose items"))
```

```{r}
gAlPlInBag <- FreqWInBAG %>%
  filter(Item %in% c("Placement Artifact", "Alignment Artifact")) %>%
ggplot_freq(
  item. = "Item",
  rating. = "MeanImageR",
  prctg. = "Percentage") +
  facet_wrap(~FTI_In_BagLabel, ncol = 2)

gGenSceInBag <- FreqWInBAG %>%
  filter(Item %in% c("Unrealistic Scenario", "Artificial in General")) %>%
ggplot_freq(
  item. = "Item",
  rating. = "MeanImageR",
  prctg. = "Percentage") +
  facet_wrap(~FTI_In_BagLabel, ncol = 2) +
  theme(legend.position = "None")

gIBFsInBag <- FreqWInBAG %>%
  filter(Item %in% c(
    "FTI Targ. View Diff.",
    "Superposition",
    "Clutter",
    "Opacity")) %>%
ggplot_freq(
  item. = "Item",
  rating. = "MeanImageR",
  prctg. = "Percentage") +
  facet_wrap(~FTI_In_BagLabel, ncol = 2) +
  theme(legend.position = "None",
        plot.margin = margin(l = 100))

```


```{r fig.height=2}
SumPrevArtsUnrScInB %>%
  mutate(Issue = factor(Issue, levels = rev(plotFctsIss))) %>%
  ggplot(aes(x = Issue, y = Prevalence)) +
  geom_bar(stat = "identity", width = .7) +
  geom_text(
    aes(
      label = paste0(round(Prevalence, 2) , " (good: ", 1-round(Prevalence, 2), ")"),
      y = Prevalence + .02),
    hjust = 0,
    size = 3.5) +
  scale_y_continuous(limits = c(0,1)) +
  coord_flip() +
  facet_wrap(~FTI_In_Bag, ncol = 2) +
  theme_minimal() +
  theme(axis.title.y = element_blank())
```

### Optional artifacts


```{r}
FreqOptInBagLong <- FreqOptInBagLong %>%
  mutate(FTI_In_BagLabel = ifelse(FTI_In_Bag,
                                  "FTI in piece of baggage",
                                  "FTI on loose items"))

gUnimArtifacts <- ggplot_freq(FreqOptInBagLong,
            item. = "Item",
            rating. = "Rating",
            prctg. = "Percentage") +
  facet_wrap(~FTI_In_BagLabel, ncol = 2) +
  theme(
    legend.position = "None",
    strip.text = element_text(size = 12))

gUnimArtifacts
```


```{r}
?margin
```

### Plot together

```{r inBagNotInBagFull, fig.height=6.5}
  plot_grid(gAlPlInBag, gUnimArtifacts, gGenSceInBag, gIBFsInBag, 
            ncol = 1,
            align = "v",
            axis = "t",
            rel_heights = c(.25, .27, .16,  .23),
            labels = c("(a)", "(b)", "(c)", "(d)"),
            label_colour = goodContrastGrey,
            label_fontface = "plain")
```


## Overview Correlations

```{r}
PerformanceAndRatingsImagesWide

```

```{r}
glimpse(PerformanceAndRatingsImagesWide)
```

```{r  fig.width=12, fig.height=12}
VariableToCorr <- PerformanceAndRatingsImagesWide %>%
  mutate(FTI_In_Bag = as.numeric(FTI_In_Bag)) %>%
  select(
    PlacementArtifact,
    AlignmentArtifact,
    UnrealisticScenario,
    FTITarg.ViewDiff.,
    RealFTIViewDiffic,
    LogSuperposition,
    LogBagComplexity,
    FTI_In_Bag
  )

```

```{r CorrFull, fig.width=12, fig.height=12}
VariableToCorr %>%
  ggpairs()

VariableToCorr %>%
  apa.cor.table("FUllLG.doc")
```


```{r CorrInBag,fig.width=12, fig.height=12}
VariableToCorr %>%
  filter(FTI_In_Bag == 1) %>%
  select(-FTI_In_Bag) %>%
  ggpairs()

temp <-VariableToCorr %>%
  filter(FTI_In_Bag == 1) %>%
  select(-FTI_In_Bag) %>%
  cor(method = "pearson") %>%
  round(2) %>%
  as_tibble(rownames = "Factors")

names(temp) <-c(
  "Factors",
  "Plac.",
  "Align.",
  "UnrealSce",
  "FTIVD",
  "RFTIVD",
  "LgSp.",
  "LgBC.")

temp %>%
  kable(caption = "Correlations factors for in bag") %>%
  kable_minimal(c("striped", "hover"))

VariableToCorr %>%
  filter(FTI_In_Bag == 1) %>%
  select(-FTI_In_Bag) %>%
  apa.cor.table("FTIInBagLG.doc")

```

```{r CorrOutBag, fig.width=12, fig.height=12}
VariableToCorr %>%
  filter(FTI_In_Bag == 0) %>%
  select(-FTI_In_Bag) %>%
  ggpairs()

VariableToCorr %>%
  filter(FTI_In_Bag == 0) %>%
  select(-FTI_In_Bag) %>%
  apa.cor.table("FTINotInBGLG.doc")
```










